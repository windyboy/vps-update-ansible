---
- name: Include pre-checks
  ansible.builtin.include_tasks: precheck.yml
  when: system_update_pre_check_enabled | default(true) | bool
  tags: precheck

- name: Update APT cache with retry
  # APT cache updates can fail due to temporary network issues or mirror problems
  # Retry up to 3 times with 10 second delays to handle transient failures
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: "{{ system_update_cache_valid_time | default(3600) }}"
  retries: 3
  delay: 10
  register: apt_cache_update
  until: apt_cache_update is success
  tags:
    - update
    - packages

- name: Perform dist-upgrade with retry
  # Package upgrades can fail due to download errors or repository issues
  # Retry mechanism ensures transient failures don't abort the entire update
  ansible.builtin.apt:
    upgrade: dist
    autoclean: true
    autoremove: true
    dpkg_options: 'force-confdef,force-confold'
    force_apt_get: "{{ system_update_force_apt_get | default(true) }}"
  environment:
    DEBIAN_FRONTEND: noninteractive
    APT_LISTCHANGES_FRONTEND: none
  register: upgrade_result
  retries: 2
  delay: 30
  until: upgrade_result is success
  tags:
    - update
    - packages

- name: Check if reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required
  tags:
    - update
    - reboot

- name: Display reboot requirement status
  ansible.builtin.debug:
    msg: "Reboot {{ 'IS' if reboot_required.stat.exists else 'is NOT' }} required on {{ ansible_hostname }}"
  tags:
    - update
    - reboot

- name: Check which packages require reboot (informational)
  ansible.builtin.command: cat /var/run/reboot-required.pkgs
  register: reboot_packages
  changed_when: false
  failed_when: false
  when: reboot_required.stat.exists
  tags:
    - update
    - reboot

- name: Display packages requiring reboot
  ansible.builtin.debug:
    msg: "Packages requiring reboot: {{ reboot_packages.stdout_lines }}"
  when:
    - reboot_required.stat.exists
    - reboot_packages.stdout_lines is defined
  tags:
    - update
    - reboot

- name: Reboot system if required
  ansible.builtin.reboot:
    reboot_timeout: "{{ system_update_reboot_timeout | default(600) }}"
    post_reboot_delay: "{{ system_update_post_reboot_delay | default(30) }}"
    test_command: uptime
    msg: >-
      Rebooting due to system updates.
      {% if reboot_packages.stdout_lines | default([]) | length > 0 %}
      Affected packages: {{ reboot_packages.stdout_lines | join(', ') }}
      {% else %}
      Reason: System reboot flag detected (/var/run/reboot-required)
      {% endif %}
  when:
    - system_update_auto_reboot | default(true) | bool
    - reboot_required.stat.exists
  tags:
    - update
    - reboot

- name: Generate JSON update report and send notifications
  ansible.builtin.include_tasks: report.yml
  when:
    - system_update_report_enabled | default(false) | bool
  tags:
    - report
    - notify
